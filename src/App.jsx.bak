import React, { useState, useEffect } from 'react';
import './App.css';
import StatsGrid from './components/StatsGrid';
import TabNavigation from './components/TabNavigation';
import DynamicTab from './components/DynamicTab';
import Footer from './components/Footer';
import { FiRefreshCw, FiAlertCircle } from 'react-icons/fi';
import axios from 'axios';
import DataExportPage from './pages/DataExportPage';
// OR create a simple navigation component

// Add this after the StatsGrid component in your return (around line 290)
<div style={{
  display: 'flex',
    justifyContent: 'flex-end',
    marginBottom: '20px',
    gap: '10px'
}}>
  <button
onClick={() => window.location.href = '/export'} // If using simple navigation
style={{
  padding: '10px 20px',
    background: colors.pine,
    color: colors.text,
    border: 'none',
    borderRadius: '5px',
    cursor: 'pointer',
    display: 'flex',
    alignItems: 'center',
    gap: '5px',
    fontFamily: 'Fira Code, monospace'
}}
  >
  <FiDownload /> Export Data
  </button>
  </div>
  const API_BASE_URL = 'http://localhost:5000/api';

function App() {
  const [activeTab, setActiveTab] = useState('');
  const [scrapers, setScrapers] = useState([]);
  const [tenderData, setTenderData] = useState({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [lastUpdated, setLastUpdated] = useState(new Date());
  const [apiStatus, setApiStatus] = useState('checking');
  const [initialized, setInitialized] = useState(false);
  const [showExportPage, setShowExportPage] = useState(false); 

  // Check API health on mount
  useEffect(() => {
    console.log('Checking API health...');
    checkApiHealth();
  }, []);

  // Fetch available scrapers after API is connected
  useEffect(() => {
    if (apiStatus === 'connected') {
      console.log('API connected, fetching scrapers...');
      fetchScrapers();
    }
  }, [apiStatus]);

  const checkApiHealth = async () => {
    try {
      console.log('Fetching from:', `${API_BASE_URL}/health`);
      const response = await axios.get(`${API_BASE_URL}/health`);
      console.log('Health check response:', response.data);
      if (response.data.status === 'healthy') {
        setApiStatus('connected');
        console.log('✅ Connected to backend API');
      } else {
        setApiStatus('disconnected');
        setError('⚠️ Backend API returned unhealthy status');
      }
    } catch (err) {
      console.error('❌ Backend connection failed:', err.message);
      setApiStatus('disconnected');
      setError('⚠️ Cannot connect to backend server. Please make sure it\'s running on port 5000.');
      setLoading(false);
    }
  };

  const fetchScrapers = async () => {
    try {
      console.log('Fetching scrapers from:', `${API_BASE_URL}/scrapers`);
      const response = await axios.get(`${API_BASE_URL}/scrapers`);
      console.log('Scrapers response:', response.data);

      const scraperList = Object.values(response.data);
      console.log('Processed scrapers:', scraperList);

      setScrapers(scraperList);
      if (scraperList.length > 0) {
        setActiveTab(scraperList[0].name);
        // After setting scrapers, fetch data
        fetchAllData();
      } else {
        setError('No scrapers found on backend');
        setLoading(false);
      }
    } catch (err) {
      console.error('Error fetching scrapers:', err);
      // Fallback to default scrapers if API fails
      const defaultScrapers = [
        { name: 'bdjobs', display_name: 'BD Jobs' },
        { name: 'bppa', display_name: 'BPPA' },
        { name: 'care', display_name: 'CARE' },
        { name: 'bppa', display_name: 'BPPA' },
        { name: 'pksf', display_name: 'PKSF' },
        { name: 'undp', display_name: 'UNDP' },
        { name: 'ungm', display_name: 'UNGM/UNOPS' },
        { name: 'worldbank', display_name: 'WORLD BANK' }
      ];
      setScrapers(defaultScrapers);
      setActiveTab('bdjobs');
      loadSampleData();
    }
  };

  const fetchAllData = async (force = false) => {
    try {
      setLoading(true);
      setError(null);
      console.log('Fetching all data...');

      const response = await axios.get(`${API_BASE_URL}/scrape/all`, {
        params: { force }
      });

      console.log('Data response:', response.data);

      if (response.data.success) {
        setTenderData(response.data.data);
        setLastUpdated(new Date(response.data.timestamp));
        setApiStatus('connected');
        console.log('✅ Data loaded successfully');
      } else {
        throw new Error(response.data.error || 'Failed to fetch data');
      }
    } catch (err) {
      console.error('Error fetching data:', err);
      setError(err.message || 'Failed to fetch tender data. Using sample data.');
      loadSampleData();
    } finally {
      setLoading(false);
      setInitialized(true);
    }
  };

  const loadSampleData = () => {
    console.log('Loading sample data...');
    const sampleData = {
      bdjobs: [
        {
          id: 1,
          organization: "World Bank",
          title: "Consultant for Digital Transformation Project",
          link: "#",
          logo: "https://via.placeholder.com/60x60?text=WB",
          posted: "2024-12-20"
        },
        {
          id: 2,
          organization: "UNDP Bangladesh",
          title: "Supply and Installation of IT Equipment",
          link: "#",
          logo: "https://via.placeholder.com/60x60?text=UNDP",
          posted: "2024-12-19"
        }
      ],
      care: [
        {
          id: 1,
          deadline: "25 Dec 2024",
          title: "Project Manager - Food Security",
          download_url: "#",
          organization: "CARE Bangladesh"
        }
      ],
      pksf: [
        {
          id: 1,
          date: "15 Dec 2024",
          title: "Procurement of Office Equipment",
          link: "#",
          views: "234",
          likes: "12",
          author: "PKSF Admin"
        }
      ],
      undp: [],
      ungm: [],
      bppa: [],
      worldbank: []
    };
    setTenderData(sampleData);
    setInitialized(true);
  };

  const handleRefresh = async () => {
    await fetchAllData(true);
  };

  const handleRetryConnection = () => {
    setError(null);
    setLoading(true);
    checkApiHealth();
  };

  // Rosé Pine color palette
  const colors = {
    base: '#191724',
    surface: '#1f1d2e',
    rose: '#ebbcba',
    pine: '#31748f',
    gold: '#f6c177',
    love: '#eb6f92',
    iris: '#c4a7e7',
    text: '#e0def4',
    muted: '#908caa',
    overlay: '#26233a'
  };

  // Show loading state
  if (loading && !initialized) {
    return (
      <div className="app" style={{ background: colors.base, minHeight: '100vh' }}>
      <div className="loading-screen" style={{
        display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          height: '100vh',
          background: colors.base
      }}>
      <div className="loading-spinner" style={{
        width: '50px',
          height: '50px',
          border: `3px solid ${colors.rose}30`,
          borderRadius: '50%',
          borderTopColor: colors.rose,
          animation: 'spin 1s ease-in-out infinite'
      }}></div>
      <div style={{ marginTop: '20px', color: colors.text, fontFamily: 'Fira Code, monospace' }}>
      Loading tender dashboard...
      </div>
      {apiStatus === 'disconnected' && (
        <div style={{ marginTop: '20px', textAlign: 'center' }}>
        <p style={{ color: colors.gold }}>⚠️ Backend server not running</p>
        <button
        onClick={handleRetryConnection}
        style={{
          marginTop: '10px',
            padding: '10px 20px',
            background: colors.pine,
            color: colors.text,
            border: 'none',
            borderRadius: '5px',
            cursor: 'pointer',
            fontFamily: 'Fira Code, monospace'
        }}
        >
        Retry Connection
        </button>
        </div>
      )}
      </div>
      </div>
    );
  }

  // If showing export page, render it
  if (showExportPage) {
    return <DataExportPage onClose={() => setShowExportPage(false)} />;
  }

  return (
    <div className="app" style={{ background: colors.base, minHeight: '100vh' }}>
    <div className="container">
    {apiStatus === 'disconnected' && (
      <div className="warning-banner" style={{
        background: colors.gold,
          color: colors.base,
          padding: '10px',
          margin: '10px 0',
          borderRadius: '5px',
          display: 'flex',
          alignItems: 'center',
          gap: '10px',
          fontFamily: 'Fira Code, monospace'
      }}>
      <FiAlertCircle />
      <span>Backend server is not running. Please start it with 'cd backend && python run.py'</span>
      <button
      onClick={handleRetryConnection}
      style={{
        marginLeft: 'auto',
          padding: '5px 10px',
          background: colors.base,
          color: colors.gold,
          border: 'none',
          borderRadius: '3px',
          cursor: 'pointer',
          fontFamily: 'Fira Code, monospace'
      }}
      >
      Retry
      </button>
      </div>
    )}

    {error && (
      <div className="error" style={{
        background: colors.love,
          color: colors.base,
          padding: '10px',
          margin: '10px 0',
          borderRadius: '5px',
          fontFamily: 'Fira Code, monospace'
      }}>
      {error}
      </div>
    )}


    {/* Export Button - Added here */}
    <div style={{
      display: 'flex',
        justifyContent: 'flex-end',
        marginBottom: '20px',
        gap: '10px'
    }}>
    <button
    onClick={() => setShowExportPage(true)}
    style={{
      padding: '10px 20px',
        background: colors.pine,
        color: colors.text,
        border: 'none',
        borderRadius: '5px',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        gap: '5px',
        fontFamily: 'Fira Code, monospace',
        transition: 'all 0.3s'
    }}
    onMouseEnter={(e) => {
      e.target.style.background = colors.iris;
      e.target.style.color = colors.base;
    }}
    onMouseLeave={(e) => {
      e.target.style.background = colors.pine;
      e.target.style.color = colors.text;
    }}
    >
    <FiDownload /> Export Data
    </button>
    </div>

    <StatsGrid
    scrapers={scrapers}
    tenderData={tenderData}
    lastUpdated={lastUpdated}
    />

    <TabNavigation
    activeTab={activeTab}
    setActiveTab={setActiveTab}
    scrapers={scrapers}
    />

    {activeTab && (
      <DynamicTab
      scraperName={activeTab}
      displayName={scrapers.find(s => s.name === activeTab)?.display_name || activeTab}
      data={tenderData[activeTab] || []}
      />
    )}

    <Footer lastUpdated={lastUpdated} />

    <button
    className="refresh-btn"
    onClick={handleRefresh}
    disabled={loading}
    style={{
      position: 'fixed',
        bottom: '20px',
        right: '20px',
        padding: '10px 20px',
        background: colors.pine,
        color: colors.text,
        border: 'none',
        borderRadius: '5px',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        gap: '5px',
        fontFamily: 'Fira Code, monospace',
        boxShadow: `0 5px 15px ${colors.base}80`,
        transition: 'all 0.3s'
    }}
    onMouseEnter={(e) => {
      e.target.style.background = colors.iris;
      e.target.style.color = colors.base;
    }}
    onMouseLeave={(e) => {
      e.target.style.background = colors.pine;
      e.target.style.color = colors.text;
    }}
    >
    <FiRefreshCw style={{ 
      animation: loading ? 'spin 1s linear infinite' : 'none',
        color: 'inherit'
    }} />
    {loading ? 'Refreshing...' : 'Refresh Data'}
    </button>
    </div>

    <style>{`
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        body {
          background: ${colors.base};
          margin: 0;
          font-family: 'Fira Code', monospace;
        }
      `}</style>
    </div>
  );
}

export default App;
